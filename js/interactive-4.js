"use strict";

// Make sure the app variable exist. It should exist, from app.framework6.js
//var app = app || {};

var disableMapControls = false;
var zoomedToArea = false;
var flying = false;
var startDelay = 0; //2000
var totalTime = 60 * 1; // Minutes - should be 60
var mapFiltersLocked = false;
var measurement = false;
var show_oil = false;

// Bounding boxes for specific layers
var bbox_area   = [[9.0088,67.3314],[18.0505,69.7181]];
var bbox_oilwells = [[0.18,55.65],	[31.73,77.17]];
var bbox_people = [[14.1779,68.1174],	[14.8645,68.308]];
var bbox_export = [[-0.11,	56.49],	[11.21,	65.02]];
var bbox_spill = [[1.36,	56.53],	[11.25,	66.07]]
// var bbox_roest  = [[11.814423,67.402211],[12.204437,67.542167]];
// var bbox_corals = [[7.9871,67.0074],[16.3368,69.3735]];
// var bbox_roest_and_oil = [[10.7865,67.351],[12.2298,67.64]];

// Set the number of interactive sections - should move it somewhere else
$(".map-features-count p span.total").text($('.map-details').length);

// Color picking for layers
//var colors = chroma.scale(['#fafa6e','#2A4858']).mode('lch').colors(5);
// var colors2 = chroma.scale('YlGnBu').colors(5);
// var colors3 = chroma.scale(['yellow', '008ae5']).mode('lch').colors(5);
// console.log(colors2)

// GeoJSON data sources for MapBox layer
// Get more data layers here: http://maps.imr.no/geoserver/web/?wicket:bookmarkablePage=:org.geoserver.web.demo.MapPreviewPage

var dataSources = [
  {
    name: 'opened_oil_areas',
    data: '../include/map-layers/opened_areas.geojson'
  },
  {
    name: 'oilwells',
    data: '../include/map-layers/wells.geojson'
  },
  // {
  //   name: 'lovese_sea',
  //   data: '../include/map-layers/lovese_blocks.geojson'
  // },
  {
    name: 'oil_prospects',
    data: '../include/map-layers/prospekter_union.geojson'
  },
  {
    name : 'export',
    data: '../include/map-layers/fields.geojson'
  }
];

var deferreds = [];
var dataLayerBounds = new Array(dataSources.length);

var mapLayers = new Array(10);
mapLayers["oil_prospects"] = {added: false,visible: false}
mapLayers["oilwells"] = {added: false,visible: false}
mapLayers["emission"] = {added: false,visible: false}
mapLayers["export"] = {added: false,visible: false}
mapLayers["spill"] = {added: false,visible: false}
mapLayers["people"] = {added: false,visible: false}
mapLayers["beach"] = {added: false,visible: false}

// ["#fafa6e", "#86d780", "#23aa8f", "#007882", "#2a4858"]
// ["#ffffd9", "#c7e9b4", "#41b6c4", "#225ea8", "#081d58"]
var mapLayersStyle = new Array(6);
mapLayersStyle["oil_prospects"] = {color: "#000",opacity: 0.8, border_color: "#000"}
mapLayersStyle["opened_oil_areas"] = { color: "#E7A930", opacity: 1, border_color: "#fff"}

var mapIcons = ["heike", "gaute", "odda", "image360_1", "image360_2", "image360_3", "image360_4", "image360_5", "image360_6", "image360_7", "image360_8", "image360_9", "image360_10", "image360_11", "image360_12", "image360_13", "image360_14"];
var addedPeople = false;
var added360Markers = false;
var addedBeachMarkers = false;
var addedSpillMarkers = false;

var addedMapIcons = new Array(18);
addedMapIcons["heike"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["gaute"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["odda"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_1"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_2"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_3"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_4"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_5"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}

addedMapIcons["image360_6"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_7"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_8"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_9"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_10"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_11"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_12"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_13"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["image360_14"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}

addedMapIcons["spill_1"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["spill_2"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["spill_3"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["spill_4"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["spill_5"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["spill_6"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["spill_7"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}
addedMapIcons["spill_8"] = {zoomedTo: false,playedVideo: false,clicked: 0,coordinates: []}

var zoomed = new Array(4);
zoomed["first"] = false;
zoomed["heike"] = false;
zoomed["gaute"] = false;
zoomed["odda"] = false;

var paused;
var countdown;

var land_labels_images = [{
    name: "lofoten",
    coordinates: [14.248825694533252, 68.26400752799873],
    imgUrl: "_ICN_LABEL_Lofoten-Archipelago@2x.png",
    localhost: "http://lovese.dev/resources/_Graphics/_GFX_005_EP2_LD/",
    beta: "https://beta.lovese.no/resources/_Graphics/_GFX_005_EP2_LD/",
    live: "https://www.lovese.no/resources/_Graphics/_GFX_005_EP2_LD/"
  },
  {
    name: "vesteralen",
    coordinates: [14.908509488458321, 68.72214903472567],
    imgUrl: "_ICN_LABEL_Vesterålen-Archipelago@2x.png",
    localhost: "http://lovese.dev/resources/_Graphics/_GFX_005_EP2_LD/",
    beta: "https://beta.lovese.no/resources/_Graphics/_GFX_005_EP2_LD/",
    live: "https://www.lovese.no/resources/_Graphics/_GFX_005_EP2_LD/"
  },
  {
    name: "senja",
    coordinates: [17.457677872120883, 69.30793670755747],
    imgUrl: "_ICN_LABEL_Senja-Archipelago@2x.png",
    localhost: "http://lovese.dev/resources/_Graphics/_GFX_005_EP2_LD/",
    beta: "https://beta.lovese.no/resources/_Graphics/_GFX_005_EP2_LD/",
    live: "https://www.lovese.no/resources/_Graphics/_GFX_005_EP2_LD/"
  }
];

var people = {
  "type": "FeatureCollection",
  "features": [
    // {
    //   "type": "Feature",
    //   "properties": {
    //     "title": "Heike",
    //     "name": "heike",
    //     "iconSize": [42, 42],
    //     "imgPath": "EP4/",
    //     "imgName": "heike@3x"
    //   },
    //   "geometry": {
    //     "type": "Point",
    //     "coordinates": [
    //       14.22199493102596,
    //       68.1608805347768
    //     ]
    //   }
    // },
    {
      "type": "Feature",
      "properties": {
        "title": "Gaute",
        "name": "gaute",
        "iconSize": [42, 42],
        "imgPath": "EP4/",
        "imgName": "gaute@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          14.440113443757042,
          68.21202830918577
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Odd Arne",
        "name": "odda",
        "iconSize": [42, 42],
        "imgPath": "EP4/",
        "imgName": "odda@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          14.487515572335155,
          68.21044769739109
        ]
      }
    }
  ]
};

var images360 = {
  "type": "FeatureCollection",
  "features": [{
        "type": "Feature",
        "properties": {
          "title": "Festvågtind",
          "name": "image360_1",
          "iconSize": [42, 42],
          "imgPath": "_GFX_006_EP3_BG/",
          "imgName": "_ICN_BTN_360@3x"
        },
        "geometry": {
          "type": "Point",
          "coordinates": [
            14.227638888889,
            68.172030555556
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "title": "Henningsvær",
          "name": "image360_2",
          "iconSize": [42, 42],
          "imgPath": "_GFX_006_EP3_BG/",
          "imgName": "_ICN_BTN_360@3x"
        },
        "geometry": {
          "type": "Point",
          "coordinates": [
            14.214352777778,
            68.147161111111
          ]
        }
      },
      {
      "type": "Feature",
      "properties": {
        "title": "Kabelvåg",
        "name": "image360_3",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          14.483019444444,
          68.210269444444
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Svolvær",
        "name": "image360_4",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
            14.572338888889,
            68.230863888889
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Svolværgeita",
        "name": "image360_5",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
            14.589311111111,
            68.246158333333
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Mt. Fløya",
        "name": "image360_6",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
            14.599088888889,
            68.248127777778
        ]
      }
    }
  ]
};

var beach = {
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "title": "Unstad",
        "name": "image360_7",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
            13.5786722222222,
            68.2685111111111
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Bleik",
        "name": "image360_8",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
            15.9758388888889,
            69.2815638888889
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Bleik 2",
        "name": "image360_9",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
            15.9440222222222,
            69.2896472222222
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Nykvåg",
        "name": "image360_10",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
            14.4558027777778,
            68.7556722222222
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Nykvåg 2",
        "name": "image360_11",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
            14.4692472222222,
            68.7626444444444
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Hovden",
        "name": "image360_12",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
            14.5519888888889,
            68.8117138888889
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Nøss",
        "name": "image360_13",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
            15.5314722222222,
            69.0641694444444
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Stave",
        "name": "image360_14",
        "iconSize": [42, 42],
        "imgPath": "_GFX_006_EP3_BG/",
        "imgName": "_ICN_BTN_360@3x"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
            15.8545638888889,
            69.2252472222222
        ]
      }
    },
  ]
};

var oil_spills = {
  "type": "FeatureCollection",
  "features": [{
      "type": "Feature",
      "properties": {
        "title": "Ekofisk Bravo",
        "description": "",
        "year" : 1977,
        "tonnes" : 10668,
        "liter" :  12700194,
        "imgProfile": "",
        "name": "spill_1",
        "iconSize": [42, 42],
        "imgPath": "EP4/",
        "imgName": "_ICN_BTN_spill"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [3.21828708066431, 56.5466320366054]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Statfjord C",
        "description": "",
        "year" : 1989,
        "tonnes" : 1176,
        "liter" : 1400021,
        "imgProfile": "",
        "name": "spill_2",
        "iconSize": [42, 42],
        "imgPath": "EP4/",
        "imgName": "_ICN_BTN_spill"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [1.794748439008231, 61.192582432191614]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Statfjord",
        "description": "",
        "year": 1992,
        "tonnes" : 756,
        "liter" :  900014,
        "imgProfile": "",
        "name": "spill_3",
        "iconSize": [42, 42],
        "imgPath": "EP4/",
        "imgName": "_ICN_BTN_spill"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [1.8555329090256123, 61.261181617523874]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Draugen",
        "description": "",
        "year": 2003,
        "tonnes" : 756,
        "liter" :  900014,
        "imgProfile": "",
        "name": "spill_4",
        "iconSize": [42, 42],
        "imgPath": "EP4/",
        "imgName": "_ICN_BTN_spill"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [7.7340479964090605, 64.29762864545]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Norne",
        "description": "",
        "year": 2005,
        "tonnes" : 286,
        "liter" : 340005,
        "imgProfile": "",
        "name": "spill_4",
        "iconSize": [42, 42],
        "imgPath": "EP4/",
        "imgName": "_ICN_BTN_spill"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [8.07016745468301, 66.0216659074382]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Draugen",
        "description": "",
        "year": 2006,
        "tonnes" : 82,
        "liter" : 97621,
        "imgProfile": "",
        "name": "spill_5",
        "iconSize": [42, 42],
        "imgPath": "EP4/",
        "imgName": "_ICN_BTN_spill"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [7.75603951880394, 64.3324259518666]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Statfjord A",
        "description": "",
        "year": 2007,
        "tonnes" : 3696,
        "liter" :  4400067,
        "imgProfile": "",
        "name": "spill_6",
        "iconSize": [42, 42],
        "imgPath": "EP4/",
        "imgName": "_ICN_BTN_spill"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [1.9063482184736529, 61.32761665988892]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Statfjord C",
        "description": "",
        "year": 2009,
        "tonnes" : 80,
        "liter" : 95240,
        "imgProfile": "",
        "name": "spill_7",
        "iconSize": [42, 42],
        "imgPath": "EP4/",
        "imgName": "_ICN_BTN_spill"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [1.794748439008231, 61.192582432191614]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "title": "Draugen",
        "description": "",
        "year": 2009,
        "tonnes" : 80,
        "liter" : 95240,
        "imgProfile": "",
        "name": "spill_8",
        "iconSize": [42, 42],
        "imgPath": "EP4/",
        "imgName": "_ICN_BTN_spill"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [7.718317822619525, 64.25505514133008]
      }
    },
  ]
};

var distanceContainer = document.getElementById('distance');

// GeoJSON object to hold our measurement features
var geojson = {
    "type": "FeatureCollection",
    "features": []
};

// Used to draw a line between points
var linestring = {
    "type": "Feature",
    "geometry": {
        "type": "LineString",
        "coordinates": []
    }
};

mapboxgl.accessToken = 'pk.eyJ1IjoibG92ZXNlIiwiYSI6ImNpeTF0NTIxdzAwODMycWx4anRuc2dteGoifQ.h_sW40YOKtU1XOVyrJlqaw';

var map = new mapboxgl.Map({
  container: 'map', // container id
  style: 'mapbox://styles/lovese/ciy1xowr100e22rqlyky3qgcg', //hosted style id
  center: [12.9, 68.7], // starting position: lng/lat
  zoom: 6, // starting zoom,
  pitch: 0, // pitch in degrees
  bearing: 0, // bearing in degrees
  attributionControl: false
});

if (disableMapControls) {
  mapControls(true);
}

function mapControls(disable) {
  if (disable) {
    map.scrollZoom.disable();
    map.dragRotate.disable();
    map.dragPan.disable();
    map.touchZoomRotate.disableRotation();
    map.doubleClickZoom.disable();
  } else {
    map.scrollZoom.enable();
    map.dragRotate.enable();
    map.dragPan.enable();
    map.touchZoomRotate.enable();
    map.doubleClickZoom.enable();
  }
}

var d = new Date( "01 " + "January 1966");
var first = d.getFullYear();
var s = new Date( "01 " + "December 2017");
var second = s.getFullYear();
var years = Array();
for(var i = first; i <= second; i++) years.push(i);

// Data from NPD.no
var wells_accumulated = [2,8,20,34,55,71,87,110,162,212,243,300,370,436,512,571,660,727,818,937,1051,1199,1315,1435,1555,1685,1819,1979,2154,2311,2500,2704,2880,3094,3313,3550,3748,3944,4103,4286,4484,4689,4945,5218,5423,5624,5849,6086,6320,6577,6793,6931];
var weels_yearly = [2,6,12,14,21,16,16,23,52,50,31,57,70,66,76,59,89,67,91,119,114,148,116,120,120,130,134,160,175,157,189,204,176,214,219,237,198,196,159,183,198,205,256,273,205,201,225,237,234,257,216,138];

var d_emissions = new Date( "01 " + "January 1990");
var first_emissions = d_emissions.getFullYear();
var s_emissions = new Date( "01 " + "December 2016");
var second_emissions = s_emissions.getFullYear();
var years_emissions = Array();
for(var i = first_emissions; i <= second_emissions; i++) years_emissions.push(i);

var prev = 0;
// Calculated with numbers from NPD and NNV
var oil_prod_emissions_share = [0.219863321,0.225454225,0.233951539,0.2346436,0.242365916,0.246406944,0.248413156,0.257537598,0.248742461,0.256774163,0.290064216,0.30177542,0.302618316,0.299676641,0.30149348,0.3079696,0.29857917,0.31600759,0.317132929,0.304732153,0.291015795,0.291352254,0.296272191,0.297487641,0.316145028,0.32098876,0.320339445]
var oil_prod_emissions = [35.704,34.069,34.832,36.532,38.446,38.477,41.592,41.691,41.947,42.699,42.201,43.539,42.661,43.914,44.326,43.553,43.918,45.847,44.896,43.215,45.836,44.925,44.557,44.301,43.964,44.662,44.072]

var data3 = {1971: {F43506: 0.9931451580000001}, 1972: {F43506: 5.35904262}, 1973: {F43506: 5.19913512}, 1974: {F43506: 5.601401208}, 1975: {F43506: 30.578015511000004}, 1976: {F43506: 45.126691865999994}, 1977: {F43513: 2.66331801, F43506: 47.384891169, F43555: 2.1213755850000005, F43785: 0.013723983}, 1978: {F43506: 54.114589806000005, F43513: 20.346549843000002, F43520: 4.1141725110000005, F43555: 9.926030901, F43785: 0.4939205670000001}, 1979: {F43658: 0.7213663709999999, F43527: 5.838762591, F43506: 50.159018487, F43520: 15.466478555999998, F43513: 15.163505988, F43437: 3.058340958, F43541: 0.16383748799999998, F43555: 18.510970881000006, F43785: 1.941132876}, 1980: {F43658: 9.536552360999998, F43527: 20.315260662, F43506: 47.399563194, F43520: 13.457148372, F43513: 10.400824377000001, F43437: 8.419981392, F43541: 4.625701044000001, F43555: 22.172541026999998, F43785: 3.4025690880000004}, 1981: {F43658: 22.04821296, F43527: 17.697570414, F43506: 41.726722254, F43520: 8.360834289, F43665: 2.0035658880000002, F43513: 5.244017856, F43437: 9.55388127, F43541: 3.0615087119999997, F43555: 24.39430449, F43785: 2.683504554}, 1982: {F43658: 31.694091993000004, F43527: 15.136580547, F43506: 39.110526378, F43520: 7.840035690000001, F43665: 2.926785582, F43513: 5.672517171, F43437: 7.64303373, F43541: 1.958781324, F43555: 22.687174293, F43548: 0.24209562899999998, F43785: 2.8115708400000003}, 1983: {F43658: 52.961719968000004, F43527: 14.257329336000002, F43568: 0.128928549, F43506: 38.535551276999996, F43520: 5.670542192999999, F43665: 3.0802108740000005, F43513: 5.791316085, F43437: 6.1750614420000005, F43541: 1.3541497949999999, F43555: 23.910200928000002, F43548: 3.0612965669999994, F43785: 2.6875448969999995}, 1984: {F43658: 62.396554473, F43527: 13.140926127, F43568: 3.86968092, F43506: 37.937969994, F43520: 4.97154195, F43665: 8.575315722000001, F43610: 3.409134561, F43513: 4.414450629, F43437: 4.286195148, F43541: 1.005775557, F43555: 22.471956357, F43548: 9.582002619, F43785: 1.89840315}, 1985: {F43658: 81.66614542200001, F43527: 13.22015424, F43568: 4.982098395, F43506: 32.885360559000006, F43520: 4.469681025, F43665: 5.147899025999998, F43610: 7.9568674679999996, F43513: 4.429546113, F43437: 3.619568811, F43541: 0.7841159699999999, F43555: 19.151665520999998, F43548: 9.468198879, F43785: 1.620756471}, 1986: {F43658: 105.686365617, F43527: 13.220290974, F43568: 3.588607407, F43686: 0.12370722300000003, F43506: 20.987011971, F43520: 3.0252222269999995, F43590: 5.5044905580000005, F43665: 2.769180159, F43610: 7.5412017989999995, F43513: 4.384185693, F43437: 3.17941395, F43625: 0.808667523, F43541: 0.531345576, F43555: 18.294855950999995, F43785: 1.3997549850000002, F43548: 8.628139860000001, F43800: 2.5858450440000005}, 1987: {F43658: 108.590521725, F43527: 12.415640508000001, F43568: 2.5522875329999994, F43686: 11.486578791, F43506: 21.363815312999996, F43520: 2.285656323, F43590: 9.270523827, F43665: 1.0636861049999997, F43610: 7.771942268999999, F43513: 4.002021009, F43437: 2.5638196260000004, F43625: 2.246511267, F43541: 0.18066200100000002, F43555: 17.307229479, F43785: 0.958121553, F43548: 11.799017265, F43800: 14.330696232}, 1988: {F43658: 107.27701185900001, F43444: 1.2231891030000002, F43568: 2.506774704, F43686: 25.493858789999997, F43506: 25.722482982000002, F43520: 2.2612454640000004, F43527: 16.74911673, F43665: 1.5504198599999996, F43610: 6.100166904000001, F43590: 9.588828774, F43513: 3.6163280070000003, F43576: 0.873001833, F43437: 2.062083672, F43625: 3.131286417, F43541: 0.27524515199999994, F43555: 15.532049763, F43785: 1.2136675379999997, F43548: 12.603770382, F43800: 15.994411574999999}, 1989: {F43658: 104.84898198900001, F43444: 4.970406978, F43568: 2.514866991, F43686: 45.764905959000004, F43506: 32.199156177, F43520: 2.309877003, F43527: 16.413798315, F43665: 1.4216659649999999, F43610: 6.328868931000001, F43590: 8.708732151, F43513: 2.559481917, F43576: 3.3735240060000002, F43437: 1.5548934, F43625: 37.583279424000004, F43541: 0.605730831, F43555: 11.494254360000001, F43785: 0.866007078, F43548: 14.491469426999998, F43800: 15.927353682}, 1990: {F43686: 43.793778894, F43527: 14.213085359999997, F43665: 1.38207837, F43513: 1.812300879, F43576: 3.079980804, F43785: 0.6681206909999999, F46437: 2.9236958910000004, F43485: 0.500726709, F43520: 2.002761702, F43618: 8.341473318, F43541: 0.638987358, F43610: 5.88336876, F43658: 102.80976637799999, F43444: 5.104675158000001, F43568: 2.7491039909999997, F43506: 34.831009305, F43792: 0.08893447499999999, F43492: 4.916244672000001, F43590: 8.805608667, F43548: 14.431680012000001, F43437: 1.1563745400000003, F43625: 48.135572568, F43800: 17.286247542, F43555: 5.190456440999999}, 1991: {F43686: 58.795497618, F43527: 13.418921592, F43665: 1.1435367180000002, F43513: 1.393033371, F43576: 3.506514864, F43785: 0.582903081, F46437: 0.4896006120000001, F43485: 4.887560316000001, F43520: 1.404680853, F43618: 10.192462377, F43541: 0.504761274, F43610: 6.322029474000001, F43658: 106.583404458, F43444: 3.7943535149999996, F43568: 1.792151436, F43506: 37.011553326, F43562: 0.35751701700000005, F43792: 0.558149688, F43492: 10.445198028, F43590: 8.965224549, F43548: 12.781774755, F43437: 0.924367545, F43625: 58.167059499000004, F43800: 20.980746492, F43555: 3.354518448}, 1992: {F43686: 74.34384354, F43527: 12.434694501000003, F43665: 1.376478474, F43513: 1.175202405, F43576: 2.499458436, F43785: 0.566552751, F46437: 0.17578701000000002, F43485: 4.305367179, F43520: 1.3973142060000001, F43618: 11.542462089, F43541: 0.5844897090000001, F43718: 4.525467504, F43610: 5.14549257, F43658: 112.88466180599998, F43444: 4.089830211, F43568: 1.0945295039999998, F43506: 40.177966437, F43792: 0.41824217099999994, F43492: 11.927878460999999, F43590: 9.156076299, F43548: 13.818911949, F43437: 0.891573741, F43625: 72.595237905, F43800: 22.541367102, F43555: 3.6822077940000004}, 1993: {F43534: 2.48215371, F43686: 85.44106536000001, F43527: 11.172063957000002, F43665: 0.841128147, F43513: 1.338036795, F43576: 2.8424143199999996, F43785: 0.523023276, F46437: 0.167199282, F43485: 2.9800441920000003, F43520: 1.222183818, F43478: 3.73899534, F43618: 11.710585737000002, F43541: 0.4699134809999999, F43718: 20.791145835, F43610: 3.382486908, F43658: 102.204232782, F43444: 4.294478196, F43568: 0.17813569799999998, F43758: 0.342435654, F43506: 36.64877337, F43651: 3.0269072159999997, F43792: 0.219879621, F43492: 12.27783105, F43590: 9.130663188, F43548: 12.034215084, F43437: 1.024883334, F43625: 79.155347148, F43800: 22.625094519, F43555: 3.024528765}, 1994: {F43534: 5.101613229, F43686: 90.96912297000002, F43527: 10.148151075, F43665: 0.6593795130000001, F43513: 1.154531073, F43576: 2.2006416449999997, F43785: 0.520324437, F46437: 0.16848410399999997, F43485: 2.107309587, F43520: 1.1484767790000001, F43478: 19.35984846, F43618: 13.495283148, F43541: 0.466652343, F43718: 29.816127582, F43583: 2.385972426, F43610: 1.2728755740000002, F43658: 98.31073181699998, F43444: 3.19626882, F43758: 10.809696942, F43506: 40.50833196, F43651: 15.696710078999999, F43672: 1.800802926, F43492: 12.562389741000002, F43590: 8.548818954, F43548: 10.622676018, F43437: 0.872438862, F43625: 81.237618117, F43800: 16.780118784000003, F43555: 2.34851433, F43725: 4.622973402}, 1995: {F43534: 4.593428025, F43686: 83.11854486600001, F43527: 12.563939175000002, F43665: 0.5849096819999999, F43513: 0.8430627930000002, F43576: 0.710486613, F43785: 0.54356202, F46437: 7.942994865000001, F43485: 1.789148286, F43520: 1.1308579530000002, F43478: 25.869855731999998, F43618: 13.872737595000004, F43541: 0.490498164, F43771: 2.944347597, F43597: 2.777933244, F43718: 34.533824253000006, F43583: 2.576136075, F43548: 11.876903072999998, F43658: 81.41617545000001, F43444: 2.777619708, F43758: 19.386045089999996, F43506: 49.20552981, F43679: 7.505321616, F43651: 18.219136605, F43672: 9.427892145000001, F43492: 11.544222056999999, F43590: 8.919836838, F43437: 0.784157658, F43625: 80.60792463000001, F43800: 11.649344667000001, F43555: 1.477200588, F43725: 12.525055866000002}, 1996: {F43534: 3.725123058, F43686: 75.146600535, F43527: 10.738801646999999, F43665: 0.6802473240000001, F43513: 0.649763802, F43576: 1.3557888029999998, F1035937: 0.220238514, F43785: 0.487097418, F46437: 49.279165971, F43485: 1.8960541350000006, F43520: 1.176818502, F43478: 31.471190832, F43618: 12.834458004, F43541: 0.46768191300000006, F43771: 33.898387680000006, F43597: 5.776131636, F43718: 34.68140355000001, F43583: 1.986196146, F43548: 13.677105480000002, F43658: 70.632069024, F43444: 2.460985608, F43758: 23.483717883, F43506: 51.018933423, F43679: 10.279915788, F43651: 19.012459854000003, F43464: 0.253243161, F43672: 10.059713669999999, F43457: 1.8417945749999998, F43492: 10.844061741, F43590: 11.888850818999998, F43807: 3.3226748369999997, F43437: 0.680852646, F43625: 81.00076312799999, F43800: 8.276192688, F43555: 0.9116672100000001, F43725: 13.775357583}, 1997: {F43534: 2.8416924330000004, F43686: 71.23974432900002, F43527: 10.900790265000001, F43665: 0.8266037159999998, F43513: 0.554566287, F43576: 0.21442196100000002, F43785: 0.38860339200000005, F46437: 72.851223999, F43485: 1.5694878419999996, F43520: 1.12968225, F43478: 29.013894879, F43618: 10.162861386, F43541: 0.344302524, F43771: 38.147061561, F43651: 17.157210111000005, F43732: 4.440723048000001, F43583: 0.9785400150000001, F43548: 15.234593547, F43778: 1.154851965, F43658: 63.34144778699999, F43444: 1.9929887370000001, F43758: 29.065930190999996, F43506: 52.593098835000006, F43679: 11.532795636, F43751: 1.020685401, F43464: 1.5888394140000002, F43672: 12.41294574, F43457: 9.005333634, F43718: 32.49442829400001, F43492: 8.94429615, F43597: 4.571547327000001, F43590: 7.152934209, F43807: 5.505670845000001, F43437: 0.598363137, F43625: 75.833044965, F43800: 6.788232222000001, F43555: 1.066044831, F43725: 12.767277594000001}, 1998: {F43534: 1.848677781, F43686: 58.988328702, F43527: 6.965345127000001, F43665: 0.7760415419999999, F43513: 0.313811943, F43576: 5.994e-05, F43785: 0.24034746599999998, F46437: 81.15765680700001, F43485: 0.9704174700000002, F43520: 0.7467931109999999, F43451: 0.028257741000000003, F43478: 27.837821592, F43618: 10.067194848, F43541: 0.200467014, F43771: 33.777826173, F43651: 16.467289974000003, F43732: 13.137883398, F43583: 0.53589891, F43548: 17.051523222, F43778: 17.563886613000005, F43658: 54.4073913, F43444: 1.0056525809999999, F43758: 31.130844939000003, F43506: 49.85410884, F43679: 9.003869052000002, F43751: 4.715477505, F43464: 0.7287872760000002, F43672: 12.61445034, F43699: 0.191827818, F43457: 11.430894291000001, F43718: 30.44314033200001, F43492: 6.403280697, F43597: 2.4121485120000004, F43590: 3.512032428, F43807: 5.477905341000001, F43437: 0.34242078299999995, F43625: 67.026705336, F43800: 4.9327809689999995, F43555: 1.335470142, F43725: 12.185452992}, 1999: {F43534: 2.6449592429999997, F43686: 50.56248544499999, F43451: 4.846203972, F43665: 0.7210671390000001, F43745: 1.7469129600000004, F43765: 10.848280536, F46437: 93.028495629, F43485: 0.41189045100000005, F43520: 0.7223377710000001, F43478: 30.145204836, F43618: 5.683116042, F43771: 36.302377788, F43651: 11.160333093, F43732: 14.207667354, F43639: 2.533349169, F43548: 17.641347707999998, F43778: 23.096382984, F43658: 42.201232281, F43527: 4.696920807000001, F43758: 33.758520066, F43506: 46.953064299, F43679: 9.983395446, F43562: 2.450631105, F43751: 9.796450716, F43464: 1.0055795760000001, F43672: 11.445998073, F43699: 6.137842203, F43457: 15.904401237, F43718: 28.059725936999993, F43492: 5.58024429, F43583: 0.127004325, F43597: 2.000759406, F43590: 2.148635052, F43807: 4.126873293000001, F43625: 54.049355163, F43800: 4.164772503, F43555: 0.738479823, F43725: 13.523652336, F43604: 2.427909609}, 2000: {F43534: 2.407109193, F43686: 39.270931257, F43451: 4.832616006, F43665: 0.478803504, F43745: 6.265495665, F43765: 23.419598000999997, F46437: 107.90819886899999, F43485: 0.2940940800000001, F43520: 0.8244829920000001, F43645: 3.9825310500000004, F43478: 36.201727092, F43618: 7.447182198, F43771: 30.817320780000006, F43651: 7.907918400000002, F43732: 11.674760364000003, F43639: 7.101436455, F43548: 15.197637351000001, F43778: 28.978606791, F43658: 35.320928346, F43527: 5.273555981999999, F43758: 32.782510767000005, F43506: 54.266081178, F43679: 11.567502432000001, F43562: 11.174038532999997, F43751: 10.904935068, F43464: 0.7567880760000001, F43672: 9.122339217, F43699: 9.667611555000002, F43457: 8.663256576, F43718: 25.718623986000004, F43807: 2.979196308, F43492: 4.000844268, F43583: 0.004602555, F43597: 1.569228165, F104718: 1.7865588959999996, F43625: 47.370328059, F43800: 3.3719485859999994, F43555: 1.3391448119999998, F43725: 12.224837256, F43604: 20.622288225}, 2001: {F43534: 1.6551891060000004, F43686: 31.562171679000006, F43451: 3.29637492, F43665: 0.249297183, F43745: 7.053553196999999, F1272071: 2.0737388610000003, F43765: 36.572725923, F46437: 103.597657074, F43485: 1.1758587600000001, F43520: 0.8132323709999999, F97002: 0.291705792, F43645: 12.392052569999999, F43478: 35.106321567, F43618: 5.782083561000001, F43771: 31.849184174999998, F43651: 6.919975641000001, F43732: 10.206856791000002, F43639: 10.603538631, F43548: 14.564386284000001, F43778: 34.289041524, F43658: 32.778303285, F43527: 7.537002029999999, F43758: 35.216017308000005, F43506: 53.614897767, F43679: 8.392944194999998, F43562: 10.812572496, F43751: 8.167243581000001, F43464: 1.494852477, F43672: 7.421986115999999, F43699: 12.339828792, F43457: 9.007157423999999, F43718: 35.42752152, F43807: 0.5742904050000001, F43492: 3.869236173, F43583: 0.001145772, F43597: 0.194525211, F1028599: 1.543633458, F43590: 0.54089799, F104718: 7.091060543999999, F43625: 41.05696249499999, F43800: 3.847258023000001, F43555: 1.64307354, F43725: 14.684426625000002, F43604: 15.695926740000003}, 2002: {F43534: 1.332065598, F43686: 27.319140942, F43451: 2.180854638, F43665: 0.293988066, F43745: 6.83842338, F1272071: 5.999390118, F43765: 51.129042287999994, F853376: 0.1500819, F46437: 117.866947596, F43485: 1.1803417290000002, F43520: 0.6674205149999999, F97002: 9.393472275, F43645: 12.562906428000002, F43478: 38.026646883, F43618: 4.696273038, F43771: 30.950696667, F43651: 6.454520522999999, F43732: 8.489258352000002, F43639: 8.724260586, F43548: 14.011847922, F43778: 30.637161348, F43658: 29.422145307, F43527: 9.072351162000002, F43758: 32.733196992, F43506: 55.357106817, F43679: 6.910408308, F43562: 9.555652269, F43751: 5.181372873, F43464: 1.9149037889999998, F43672: 6.2386317689999995, F43699: 15.574772907000002, F43457: 8.505936626999999, F43718: 38.23003482, F43492: 2.27174079, F1028599: 4.9950342690000005, F43590: 1.490562888, F104718: 5.042422989, F1578893: 0.150624522, F43625: 36.596067087, F43800: 3.7573750769999994, F43555: 1.595344296, F43725: 14.247561825, F43604: 7.346383527}, 2003: {F43534: 1.437467208, F43686: 28.377292406999995, F43451: 2.56066137, F43665: 0.324477036, F43745: 5.620275855, F1272071: 4.689928458, F43765: 61.540716186, F1035937: 2.0887145460000003, F853376: 10.658517243, F1630514: 2.096776821, F46437: 120.20350244100001, F43485: 1.041414363, F43520: 0.505847532, F97002: 9.907585857, F1578840: 1.9287486450000002, F43645: 16.059601913999998, F43478: 34.60326963, F43618: 4.807213644, F43771: 28.597029432000003, F43651: 5.6219125409999995, F43732: 9.550961229, F43639: 6.267289949999999, F43548: 13.396634783999998, F1630100: 5.852111397, F43658: 25.596160335000004, F43527: 8.687790569999999, F43758: 22.141408965, F43506: 55.108982837999996, F43679: 8.585409249000001, F43562: 11.053907646, F43751: 4.905953757, F43464: 2.516509212, F43672: 6.480197412, F43699: 16.327079549999997, F43457: 7.3777753950000005, F43718: 40.197786300000004, F43492: 2.0586055439999997, F1028599: 4.229053833, F43590: 1.036420983, F104718: 4.5553558679999995, F1578893: 0.6886398300000001, F43625: 30.541744010999995, F43800: 3.2755143899999997, F43555: 1.5742527750000002, F43725: 12.754946024999999, F43778: 25.86372612, F43604: 6.321900189}, 2004: {F43534: 1.554671145, F43686: 28.810055291999998, F43451: 3.3576181019999995, F43665: 0.254278197, F43745: 5.180672061, F1272071: 2.694903021, F43765: 56.843673503999995, F1035937: 19.706574807000003, F853376: 11.584663425, F1630514: 7.602556119, F46437: 109.79989196399998, F43485: 0.925602162, F43520: 0.614371941, F97002: 9.547553286, F1036101: 2.09542764, F1578840: 8.170177536, F43645: 14.860681976999999, F43478: 32.184804422999996, F43618: 4.514896542, F43771: 27.199515957, F43651: 4.744852893, F43732: 10.969760868000002, F43639: 5.147541116999999, F43548: 15.940331489999998, F2138816: 2.05865529, F1630100: 5.826454869, F43658: 25.479578387999997, F43527: 11.171260632, F43758: 23.384829680999996, F43506: 53.05067691000001, F43679: 6.613002098999999, F43562: 17.245213704, F43751: 4.69724805, F43464: 2.038173696, F43672: 4.510052064000001, F43699: 20.377297227, F43457: 6.0878036280000005, F43718: 33.09837684300001, F43492: 1.6632541500000002, F1028599: 2.5593686430000004, F43590: 0.889630314, F104718: 3.178833174, F1578893: 0.738290946, F43625: 32.240266263, F43800: 3.082298076, F43555: 1.919468409, F43725: 11.352746406000001, F43778: 22.065762861, F43604: 3.148765671000001}, 2005: {F43534: 1.1498284620000003, F43686: 24.687035778000002, F43451: 3.5634538169999996, F43665: 0.228972099, F43745: 3.966154854, F1272071: 2.299725702, F43765: 53.631005298, F1035937: 28.665911151, F853376: 8.404181112, F1630514: 8.000545362, F46437: 105.01321291500001, F43485: 0.7443410850000002, F43520: 0.5630467890000002, F97002: 5.702327454000001, F1036101: 17.026438104, F1578840: 5.175638451, F43645: 13.212734849999999, F43478: 35.27004006, F43618: 4.422015891000001, F43771: 25.256125131, F43651: 4.585880541, F43732: 11.187218159999999, F43639: 3.0353550929999997, F43548: 16.070268000000002, F2138816: 3.4820711519999996, F1630100: 5.758709862, F43658: 21.64421382, F43527: 12.067746741, F4005142: 1.0190553960000002, F43758: 18.091656597, F43506: 50.970095025, F43679: 6.332816688, F43562: 19.988390010000003, F43751: 5.089783418999999, F43464: 1.7150708190000001, F43672: 4.642442256, F43699: 21.090384933000003, F43457: 6.97399581, F43718: 26.565022686, F1854729: 1.131069783, F43492: 2.4760995660000003, F1028599: 3.603955044, F43590: 0.774289401, F2834734: 0.562540881, F104718: 1.922641569, F1578893: 0.35149029300000006, F43625: 29.613057138000002, F43800: 3.1819757159999997, F43725: 9.385365243000003, F43778: 17.208105255000003, F43604: 2.2379369760000003}, 2006: {F43534: 1.3559997000000001, F43686: 19.408301286, F43451: 2.37363912, F43665: 0.24911950200000005, F43745: 5.952570054, F1272071: 1.6173044550000006, F43765: 49.294249557, F3505505: 2.6669798129999998, F1035937: 35.078844312, F853376: 6.533371125, F1630514: 7.4848112339999995, F46437: 101.353890963, F43485: 1.1853959040000002, F43520: 0.528662553, F97002: 3.863986023, F1036101: 22.165009593, F1578840: 4.625484345, F43645: 13.004778726, F43478: 32.190091419, F43618: 3.2122000049999997, F43771: 25.028238249, F43651: 3.576831894, F43732: 11.662569513, F43639: 1.8977526270000005, F43548: 13.419818027999998, F2138816: 3.588957552, F1630100: 4.49877069, F43658: 18.390736874999998, F43527: 10.255457361, F4005142: 0.746675445, F43758: 13.656228963, F43506: 51.179168958, F43679: 4.2525741120000005, F43562: 18.142534041, F43751: 3.8714968440000006, F43464: 1.367953602, F43672: 4.423509393000002, F43699: 18.376062372, F43457: 6.441164982, F43718: 23.939468427000005, F1854729: 16.541265873, F43492: 2.2338031380000003, F1028599: 2.72527518, F43590: 0.41353185600000003, F2834734: 5.880107138999999, F104718: 1.1485112849999999, F1578893: 0.818037645, F43625: 27.68208189, F43800: 2.890338624, F43725: 5.073309461999999, F43778: 14.703861573000001, F43604: 1.9641882120000003}, 2007: {F43534: 0.848754366, F2762452: 4.082546349, F43686: 16.557684603000002, F43451: 2.2166572319999998, F43665: 0.218040534, F43745: 9.901413219, F1272071: 1.303499196, F43765: 53.525681829, F3505505: 4.564613349, F1035937: 33.350983983000006, F853376: 4.500281568000001, F1630514: 8.385378507, F46437: 108.682952418, F43485: 0.9748420530000002, F43520: 1.030267887, F97002: 2.173384671, F1036101: 4.238526279, F1578840: 7.502596749, F43645: 10.306822008, F43478: 32.295774771, F43618: 2.539677363000001, F43771: 19.439109828000003, F43651: 3.946484946, F43732: 10.227960186, F43639: 1.5419523149999999, F43548: 11.205443558999999, F2138816: 2.86171239, F1630100: 4.197554385, F43658: 17.918764506000002, F43527: 8.807218557000002, F4005142: 1.5295722479999998, F43758: 12.313417515, F43506: 42.898170486000005, F43679: 3.4715536410000007, F43562: 16.059646362000002, F43751: 3.169431576, F43464: 1.224756165, F43672: 4.4670096809999995, F43699: 20.355418574999998, F43457: 6.396541401, F2053062: 0.660666528, F43718: 23.639349914999993, F3437650: 0.139739409, F43778: 13.317503886, F1854729: 23.590840862999997, F43492: 1.8291292739999996, F1028599: 1.888495485, F43590: 0.401943177, F2834734: 2.441837889, F104718: 1.049774661, F1578893: 0.785220705, F43625: 20.688139248000002, F43800: 2.352094011, F43725: 7.129581633, F3437659: 0.156378156, F43604: 1.5304864049999998}, 2008: {F43534: 0.999389094, F2762452: 28.080941688, F43686: 16.209346986, F43451: 1.9558300230000003, F43665: 0.211951272, F43745: 6.752429322, F1272071: 1.416385548, F43765: 50.818946823000005, F3505505: 5.583516246, F1035937: 27.913589469, F853376: 3.146801313, F1630514: 6.7452155519999994, F46437: 91.12156164, F43485: 0.6991918140000001, F43520: 0.9552159090000004, F97002: 2.987063406, F3392471: 1.506316815, F1036101: 11.699000367000002, F1578840: 9.815025963000002, F43645: 10.529450376, F43478: 27.099118296, F43618: 1.9615406100000004, F43771: 17.562239814, F43651: 5.39378076, F43732: 9.426399357000001, F43639: 1.236962637, F43548: 9.215697897000002, F2138816: 3.0134702069999997, F1630100: 3.5968470779999997, F43658: 18.765563748, F43527: 9.956963736000002, F4005142: 1.700278371, F3420717: 5.489080844999998, F43758: 12.045848465999999, F43506: 39.856595016, F43679: 2.2142504370000005, F43562: 12.572627436, F43751: 9.076890411, F43464: 1.130630574, F43672: 2.604051225, F43699: 18.891920304, F43457: 5.103228594, F2053062: 7.184671176, F43718: 24.481885157999997, F3437650: 0.40074002700000005, F43778: 10.647464991000003, F1854729: 24.58480032, F43492: 2.2003722240000005, F1028599: 1.727742633, F43590: 0.43789495500000003, F2834734: 1.4777437709999994, F104718: 0.828368127, F1578893: 0.9498426839999999, F43625: 25.812848172000002, F43800: 1.5834433830000008, F43725: 4.482664224, F3437659: 0.19033164000000002, F2845712: 6.7199034719999995, F43604: 1.117862823}, 2009: {F43534: 1.016729238, F2762452: 50.712248853000006, F43686: 13.709395095000001, F43451: 2.194000425, F43665: 0.19148004, F43745: 7.167808781999999, F1272071: 1.031328288, F43765: 53.390869386, F3505505: 4.555489491, F1035937: 29.823246549000004, F853376: 2.6971440629999996, F3392471: 4.441247747999999, F3960848: 5.571002691, F4380167: 0.026477115, F46437: 78.36454016100001, F4467554: 2.063717283, F43485: 0.619392993, F43520: 0.8879784690000001, F97002: 2.876080398, F1630514: 7.442707635, F1036101: 19.604531409, F1578840: 10.491757223999999, F43645: 8.685648960000002, F43478: 23.894568951, F43618: 1.8937715700000002, F43771: 14.756065116, F43651: 5.163613653000001, F4973114: 1.2408886799999999, F43639: 0.9887228459999998, F43548: 7.324324701000002, F2138816: 3.244396881, F1630100: 3.121982955, F43658: 13.912151706, F43527: 9.284963775000001, F4005142: 0.9254305890000002, F3420717: 8.570472372000001, F43758: 10.144112877, F43506: 36.513888039, F43679: 0.846898071, F43562: 9.453287748, F43751: 7.980108846, F4444332: 3.412220604, F43464: 0.833294565, F43672: 1.7701247310000001, F43699: 16.039290069000003, F43457: 5.320697574, F2053062: 9.784904988, F43732: 8.100491631, F3437650: 0.33201898199999996, F43778: 6.665770179, F43718: 17.238686814, F1854729: 16.857131388000003, F43492: 1.4342890019999999, F1028599: 0.9839614020000002, F43590: 0.513922719, F2834734: 1.0287756179999998, F104718: 0.360489906, F1578893: 0.85648356, F43625: 21.922764507, F43800: 2.153998821, F43725: 3.067434216, F3437659: 0.20106629999999998, F2845712: 14.819545109999998, F43604: 0.899440824}, 2010: {F43534: 0.894637851, F2762452: 50.541589032000005, F43686: 11.276970284999997, F43451: 3.9497374980000006, F43665: 0.126924951, F43745: 6.617251446000001, F1272071: 0.7211995109999998, F43765: 50.63542128, F4467574: 1.142192391, F3505505: 3.1118591909999997, F1035937: 26.849056041, F853376: 1.54000365, F3392471: 5.149670649, F3960848: 11.430240699, F4380167: 2.40896076, F46437: 84.878589723, F4467554: 3.426575754, F43485: 0.5352019260000002, F43520: 0.7060442130000002, F97002: 2.234949105, F1630514: 7.040733843, F1036101: 22.832523507, F1578840: 10.030481946, F43645: 7.798179321000001, F4467595: 0.10028279999999998, F43478: 19.048215009, F43618: 2.130081921, F43771: 10.894481802, F43651: 4.7721639300000005, F4973114: 1.276678272, F43639: 0.9848669310000002, F43548: 6.794299200000001, F2138816: 2.6536471319999992, F1630100: 2.432059605, F43658: 12.835206224999999, F43527: 9.368415117000001, F4005142: 0.630491634, F3420717: 5.243678594999999, F43758: 7.133453718000001, F43506: 30.458491005, F43679: 1.2350430480000003, F43562: 7.784420325000001, F43751: 8.390250834, F4444332: 3.182104719, F43464: 0.647820375, F43672: 2.6328329160000004, F43699: 12.636518342999999, F43457: 4.607254827, F2053062: 14.486757404999999, F43732: 5.94147189, F3437650: 0.26887446600000003, F43778: 5.847850461, F43718: 16.745500803000002, F1854729: 11.636973687, F43492: 0.85855677, F1028599: 0.8204373299999999, F43590: 0.484864728, F4966234: 1.131903153, F2834734: 1.1599111410000003, F104718: 0.151308648, F1578893: 0.043156301999999994, F43625: 21.313215618, F43800: 3.1800092099999997, F43725: 2.0462153040000004, F3437659: 0.13057351200000003, F2845712: 13.680603774, F43604: 0.7213874460000003}, 2011: {F43534: 0.722283636, F2762452: 52.86115791, F43686: 7.4058836490000015, F43451: 2.7022977000000004, F43665: 0.138168423, F43745: 3.1827776070000002, F1272071: 0.5504183010000001, F43765: 48.488815515, F4467574: 11.976844824, F3505505: 2.6908227570000003, F1035937: 22.721712759, F853376: 1.112691378, F3392471: 5.1195167700000015, F3960848: 15.118504524000004, F4380167: 5.489967858, F46437: 77.311311498, F4467554: 1.428872328, F43485: 0.217403889, F43520: 0.6389218320000001, F97002: 1.55722782, F1630514: 6.868943204999999, F1036101: 23.616265062, F1578840: 9.240286005000002, F43645: 7.580210415, F4467595: 4.398215721, F43478: 18.957196209, F43618: 2.035347096, F43771: 12.053022713999999, F43651: 3.6337506149999994, F4973114: 1.129955391, F43639: 1.4578819680000004, F43548: 5.285981136, F2138816: 2.07702387, F1630100: 2.535629499, F43658: 9.282552962999999, F43527: 9.34384944, F4005142: 0.555157125, F3420717: 2.6329037700000004, F43758: 6.451469781, F43506: 26.92383117, F43679: 0.7552619190000002, F43562: 6.450240783000003, F43751: 5.939627475, F4444332: 3.141715578, F43464: 0.477647556, F43672: 1.288129962, F43699: 8.625744756000001, F43457: 6.201267144, F2053062: 12.472279851000001, F43732: 6.242308488, F3437650: 0.288445833, F43778: 5.220695106, F43718: 15.810814776, F1854729: 10.30085319, F43492: 0.831693381, F18081500: 1.951958679, F1028599: 0.8330213759999999, F43590: 0.320373177, F4966234: 4.334052230999999, F2834734: 0.878341713, F104718: 0.174913776, F1578893: 0.07727739, F43625: 16.942048287000002, F43800: 2.116025709, F43725: 3.3096543030000003, F3437659: 0.08124413400000001, F2845712: 11.741230881, F43604: 0.6035941380000001}, 2012: {F43534: 0.57943236, F2762452: 54.112358796, F43686: 7.055691786000001, F43451: 1.799187417, F43665: 0.12139899300000001, F43745: 3.1059630210000004, F1272071: 0.28160406, F43765: 49.408879428, F4467574: 18.557049218999996, F3505505: 2.616801243, F20461008: 0.187642344, F853376: 0.892101573, F3392471: 5.099331849, F3960848: 14.397410480999998, F4380167: 5.963698953000001, F46437: 99.262233558, F4467554: 0.8985584429999999, F43485: 0.13503151500000002, F43520: 0.64924179, F97002: 1.2471408840000002, F1630514: 6.542628795000001, F1036101: 24.471554223, F1578840: 8.165675388, F43645: 8.313098316, F4467595: 6.263938197, F43478: 16.024929462, F43618: 2.5618011960000002, F43771: 10.339496745000003, F43651: 2.598907911, F18161341: 0.715854954, F5506919: 0.436674348, F43639: 1.284602223, F43548: 3.075076578, F2138816: 1.5831839159999999, F18212090: 1.543839309, F1630100: 2.005577382, F43658: 8.575620819000001, F43527: 8.183117073, F4005142: 1.431295614, F21106284: 0.20994216300000001, F3420717: 1.7647347239999998, F43758: 6.007378955999999, F43506: 24.115146783, F43679: 0.4885167510000001, F43562: 5.266371399, F43751: 3.2912843040000004, F4444332: 2.211964113, F43464: 0.403859877, F43672: 1.4447514989999999, F43699: 12.118777407, F43457: 5.668894614, F1035937: 19.768477086, F2053062: 13.423152704999998, F4973114: 0.9385421279999999, F3437650: 0.154367727, F43778: 2.5162598280000004, F43718: 12.5139075, F1854729: 8.368466609999999, F43492: 0.42387502199999993, F18081500: 2.454352092, F1028599: 0.648518271, F4966234: 5.402413737, F2834734: 0.9094548270000002, F43732: 5.917905456, F104718: 0.142295427, F1578893: 0.6170790030000001, F43625: 21.960615567, F43800: 1.5183307140000002, F43725: 0.692824956, F3437659: 0.005670459000000001, F2845712: 12.534622302000002, F43604: 0.48440862600000006}, 2013: {F43534: 0.549253002, F2762452: 51.859616654999996, F43686: 7.1417943269999995, F43451: 1.27987182, F43665: 0.077614929, F43745: 4.515083301, F1272071: 0.017133741, F43765: 38.691365757, F4467574: 19.031521734, F3505505: 2.4279408630000003, F20461008: 2.557301271, F853376: 1.015681347, F3392471: 3.793057119000001, F21350124: 1.7453319899999997, F3960848: 10.771563551999998, F4380167: 5.570368857, F46437: 88.26420831300001, F4467554: 0.23336438700000006, F43485: 0.111314949, F43520: 0.5812780710000001, F97002: 1.040745492, F1630514: 5.132753373000001, F1036101: 23.288870544, F1578840: 8.305140573000001, F43645: 9.388705392, F4467595: 8.281601955, F43478: 13.668733371, F43618: 2.081097261, F43771: 11.423398398, F43651: 1.900258368, F18161341: 0.500657322, F5506919: 0.43241986800000004, F43639: 1.077799572, F43548: 5.610898335, F2138816: 1.265080197, F18212090: 0.7808554470000001, F1630100: 1.5684290159999998, F43658: 9.977251149, F43527: 6.074540688, F4005142: 1.2864597569999998, F21106284: 0.36660723900000003, F3420717: 1.695983658, F43758: 4.342358397, F43506: 20.059475082000006, F43679: 0.5004844860000001, F43562: 5.491278633, F43751: 2.4407786789999997, F4444332: 1.340277198, F43464: 0.399857109, F43672: 1.143213402, F43699: 14.444693721, F43457: 4.623178575000001, F1035937: 15.309157491000002, F2053062: 12.353640818999999, F4973114: 1.377624672, F3437650: 0.130397814, F43718: 14.262805433999999, F1854729: 5.439682392000001, F43492: 0.381911667, F18081500: 1.3529040780000001, F4704482: 14.143357854000001, F1028599: 0.6880457640000001, F43590: 0.002105217, F20474183: 1.18937775, F4966234: 6.592963059, F2834734: 0.845586819, F21613906: 0.621381588, F43732: 5.688601998000002, F104718: 0.16302222, F1578893: 0.8980772760000001, F43625: 19.189968156000003, F43800: 1.562893881, F43725: 1.5658544519999997, F43778: 2.5835803230000005, F2845712: 11.034070005, F43604: 0.426863889}, 2014: {F43534: 0.7461041490000001, F2762452: 48.65804785500001, F43686: 5.941292247000001, F43451: 1.4670781589999997, F43665: 0.008423649, F43745: 6.196632204, F1854729: 6.567831969, F43765: 38.401035687000004, F4467574: 16.3564854, F3505505: 1.9767195600000003, F20461008: 3.470683716, F853376: 0.807832323, F3392471: 3.1276914779999996, F21350124: 3.5771353290000008, F3960848: 13.456993637999998, F4380167: 3.311748279, F46437: 87.50555052600001, F4467554: 0.150100404, F43485: 0.206553096, F43506: 21.499163403, F97002: 0.7108647750000001, F22507971: 2.8232044559999996, F1630514: 4.787717844, F1036101: 22.711696425000003, F1578840: 7.198398203999999, F43645: 7.283751455999999, F4467595: 9.639958986, F43478: 11.306919806999998, F43618: 2.2595467830000002, F43771: 9.730490553000001, F43651: 1.8501714119999997, F21123063: 0.026647542, F5506919: 0.36591380700000004, F43639: 1.062340311, F43548: 7.294387644000002, F2138816: 0.9294307020000001, F18212090: 3.2406679709999997, F1630100: 0.714482655, F43658: 11.282639364000001, F43527: 6.194426832, F4005142: 0.16949916900000003, F21106284: 0.6348280409999999, F3420717: 2.2607520480000005, F43758: 5.332982076, F43520: 0.577053648, F43679: 0.7994936819999999, F43562: 7.074188247, F43751: 2.9216472749999993, F4444332: 2.107386129, F43464: 0.32255157300000004, F43672: 0.7691947139999997, F43699: 15.932894505000002, F43457: 3.7183382040000006, F1035937: 11.361906207, F2053062: 14.900057355, F23410947: 0.349922106, F4973114: 1.6258192200000001, F3437650: 0.11676887700000001, F43718: 15.660886974000002, F4704482: 19.219425945, F43492: 0.364791684, F18081500: 1.537137618, F18116481: 4.9872982320000006, F1028599: 0.958295781, F18161341: 0.246101505, F20474183: 1.3118353200000001, F4966234: 5.353658459999999, F2834734: 1.252483722, F21613906: 0.284475039, F43732: 6.398161796999999, F104718: 0.09699293699999999, F1578893: 1.087721841, F43625: 14.365304721000001, F43800: 1.851115179, F43725: 2.1505404060000006, F43778: 2.3792048910000005, F2845712: 10.067752616999998, F43604: 0.32769134699999997}, 2015: {F43534: 0.6327850800000001, F20460988: 4.188525666, F2762452: 40.244027676, F43686: 5.844101859, F43451: 1.098796806, F43478: 10.843632540000002, F43745: 9.278465562, F1854729: 6.260480613, F43765: 37.122068631000005, F20460969: 4.169282873999999, F3505505: 1.7961346409999999, F20461008: 3.950321466, F21675433: 0.420345369, F853376: 0.498353853, F3392471: 2.2544690939999996, F21350124: 2.7670452899999995, F3960848: 12.522994125, F4380167: 2.1980357550000003, F46437: 99.361078605, F4467554: 0.08634133200000002, F43485: 0.20261043299999998, F43506: 20.655181977, F97002: 0.00010011600000000003, F22507971: 5.452637175, F1630514: 4.369097433, F1036101: 21.95281542, F1578840: 5.676712164, F43645: 7.260822981, F4467595: 9.419497812, F43618: 2.4232035960000005, F43771: 10.273682805, F43651: 2.39405151, F21123063: 0.790204464, F5506919: 0.285302739, F43639: 1.088926104, F43548: 7.921780086000002, F2138816: 1.1877715260000001, F18212090: 3.651205119, F1630100: 0.7598171340000002, F43658: 13.506782589, F43527: 7.50198564, F4005142: 0.559274052, F21106284: 0.775385319, F3420717: 2.6746076970000003, F43758: 5.055986703, F43520: 0.525396954, F43679: 0.906495753, F43562: 7.3106181779999995, F43751: 4.164734802, F4444332: 1.794218736, F43464: 0.272238081, F43672: 0.72197769, F43699: 14.281529370000001, F43457: 3.4443952980000003, F1035937: 11.720869344, F2053062: 16.889329403999998, F23410947: 0.748317042, F43732: 5.702678424000001, F3437650: 0.08120945099999999, F43778: 2.3015855130000005, F43718: 17.686553741999997, F4704482: 19.330983000000003, F43492: 0.280725036, F18081500: 1.728605112, F18116481: 12.909472461000002, F1028599: 0.7410724440000002, F18161341: 0.09356057100000001, F20474183: 2.7870903779999994, F4966234: 3.659142441, F2834734: 0.757979667, F21613906: 0.14923973100000001, F4467574: 17.141344821, F22492497: 2.251856583, F104718: 0.411688116, F1578893: 1.403187543, F43625: 16.912215366, F43800: 1.3741240019999998, F43725: 3.190187997000001, F3437659: 0.001229202, F2845712: 8.10036588, F43604: 0.25847483400000004}, 2016: {F43534: 0.6903634439999999, F20460988: 8.988643428, F2762452: 41.088775185, F43686: 6.338610936000002, F43451: 0.522918855, F43478: 0.941487048, F43745: 13.053643065, F43765: 37.579663638, F20460969: 7.467015459, F3505505: 1.466620725, F20461008: 2.9697743190000003, F21675433: 11.571483831, F853376: 0.32624533199999994, F3392471: 2.344348236, F21350124: 1.763078148, F3960848: 10.870365078, F4380167: 1.215841662, F46437: 94.031426577, F4467554: 0.032291685, F43485: 0.237564807, F1854729: 4.782383751, F22507971: 3.8416177800000004, F1630514: 5.326778837999999, F1036101: 21.787803261, F1578840: 5.624946141000001, F43645: 6.8770048500000005, F4467595: 8.55138624, F18161341: 0.210662793, F43618: 2.1766012710000004, F43771: 11.021379053999997, F43651: 2.4827134740000005, F21123063: 0.4960247220000001, F5506919: 0.21825017400000002, F43639: 1.2919749329999999, F43548: 6.598199252999999, F2138816: 0.226471434, F18212090: 3.0651811289999995, F1630100: 1.3007785379999999, F43658: 14.188520934, F43527: 7.747576173, F4005142: 0.255864084, F21106284: 1.223987148, F3420717: 0.9764850210000002, F43758: 3.9341340450000004, F43506: 19.394474847, F43679: 1.8435002550000006, F43562: 7.636959176999999, F43751: 0.921747984, F4444332: 1.740641592, F43464: 0.7322129340000001, F43672: 0.696423429, F43699: 17.132183589, F5774394: 8.254686564, F43457: 11.038853993999998, F1035937: 12.211371, F2053062: 17.086741677000003, F23410947: 0.44681492700000003, F43732: 5.249418888000001, F3437650: 0.08342555399999999, F43778: 1.5566703089999998, F43718: 15.935983767000003, F4704482: 17.347697004, F43492: 0.23783183400000002, F18081500: 1.421526396, F18116481: 14.345749734000002, F1028599: 0.640164825, F43590: 0.37743873299999997, F20474183: 0.917390283, F4966234: 2.6995681080000002, F23384520: 0.08100774899999998, F2834734: 0.7749424619999999, F21613906: 0.145453626, F4467574: 17.35074747, F22492497: 1.8417267149999998, F104718: 0.4638263040000001, F1578893: 0.734754603, F43625: 15.432733239000001, F43800: 1.3161549450000005, F43725: 4.024276641, F3437659: 0.028569213000000003, F2845712: 10.382179194, F43604: 0.17178057600000005}, 2017: {F43534: 0.36171242400000003, F20460988: 4.68228708, F2762452: 19.095034395000003, F43686: 2.631332142, F18161341: 0.025872731999999996, F43478: 0.34658502300000005, F43745: 6.2010411, F43765: 18.812889033, F20460969: 3.270835005, F3505505: 0.629648991, F20461008: 1.626287241, F21675433: 8.312002671000002, F4467574: 7.950055809, F3392471: 0.9995213820000002, F3960848: 6.220548663000001, F4380167: 0.03173469, F46437: 50.875118033999996, F43485: 0.116910051, F1854729: 2.4167871450000002, F22507971: 1.3717671839999996, F1630514: 3.342580644, F1036101: 9.967913247, F1578840: 3.452934522, F43645: 3.3068694360000004, F4467595: 3.2772377309999996, F43618: 0.9779746260000002, F43771: 5.528115111000001, F4467554: 0.033892641, F21123063: 0.17379581400000002, F5506919: 0.108075171, F43639: 1.206866094, F43548: 2.989012293000001, F2138816: 0.441381984, F18212090: 1.434766452, F1630100: 0.8635853820000001, F43658: 5.668428102, F43527: 4.139818614, F4005142: 0.024514755000000003, F21106284: 0.246297078, F43758: 2.2159307310000007, F43506: 10.289152398, F43679: 1.0486490370000001, F43562: 3.1870163970000003, F43651: 0.7062571980000001, F4444332: 1.2849306870000001, F43464: 0.330429648, F43672: 0.331243374, F43699: 9.597623748, F5774394: 4.587056487, F43457: 5.399193852, F1035937: 7.297672158000002, F2053062: 6.752745777, F23410947: 0.06733913400000001, F43732: 2.1917493300000004, F3437650: 0.035606181, F43718: 7.122680514000001, F4704482: 8.742817430999999, F43492: 0.09664813499999998, F18081500: 0.662179878, F18116481: 7.624769432999999, F1028599: 0.326395125, F43590: 0.695278419, F4966234: 1.156220238, F23384520: 3.543705753, F2834734: 0.821673726, F21350124: 0.7895576340000001, F22492497: 0.6029242380000001, F104718: 0.280947744, F1578893: 0.372874986, F43625: 10.309915356, F43800: 0.6668240940000001, F43725: 1.9630050030000004, F43778: 1.004075772, F2845712: 7.530063447, F23384544: 8.3406e-05, F24635035: 0.019887059999999998}}

var data_export = data3[1971]
var yearly_export_emissions = [0.993145158,5.35904262,5.19913512,5.601401208,30.57801551,45.12669187,52.18330875,88.99526363,111.0234142,139.7301415,136.7741227,137.7231932,157.6138519,177.9599072,189.4020579,202.2582865,230.1887308,253.7749395,313.9372546,330.7460325,368.3575209,413.3510938,435.2898458,488.8928847,524.2086327,599.8915086,617.4267605,597.8301708,607.5838597,645.4975989,663.0077096,675.0943717,679.6170713,682.7823835,659.7414382,634.9349715,602.8332785,611.8897352,601.4502698,574.4600837,544.9579993,554.9781407,528.0642675,535.7548188,563.4305041,570.4160979,292.8517952]
var yearly_export_accumulated_emissions = [0.993145158,6.352187778,11.5513229,17.15272411,47.73073962,92.85743148,145.0407402,234.0360039,345.0594181,484.7895596,621.5636823,759.2868754,916.9007273,1094.860635,1284.262692,1486.520979,1716.70971,1970.484649,2284.421904,2615.167936,2983.525457,3396.876551,3832.166397,4321.059282,4845.267914,5445.159423,6062.586183,6660.416354,7268.000214,7913.497813,8576.505522,9251.599894,9931.216965,10613.99935,11273.74079,11908.67576,12511.50904,13123.39877,13724.84904,14299.30913,14844.26712,15399.24527,15927.30953,16463.06435,17026.49486,17596.91095,17889.76275]

function filterBy(slider, years, year) {
    if(slider==="oilwells") {
      var filter = ['<=', 'year', years[year]];
       map.setFilter('oilwells', filter);

      // Get features which is visible on the current layer, within the current viewport
      // var features = map.queryRenderedFeatures({ layers: ['wells'] });

      // Set the label to the year
      document.getElementById('year_'+slider).textContent = years[year];
      document.getElementById('accumulated_'+slider).textContent = wells_accumulated[year].toLocaleString();
    } else if(slider==="export") {
      if (years.length > 45) years.splice(0, years.length - 47);
      data_export = data3[years[year]]
      document.getElementById('year_'+slider).textContent = years[year];
      document.getElementById('accumulated_'+slider).textContent = yearly_export_accumulated_emissions[year].toLocaleString();
      try {
        map.removeLayer("export");
      }
      catch(err) {    }
      map.addLayer({
        'source': 'export',
        'id': 'export',
        'type': 'fill-extrusion',
        'paint': {
          'fill-extrusion-opacity': 1,
          'fill-extrusion-color': {
            'property': 'id',
            'type': 'categorical',
            'stops': getColorStops()
          },
          'fill-extrusion-height': {
            'property': 'id',
            'type': 'categorical',
            'stops': getHeightStops()
          },
          'fill-extrusion-base': 0
        }
      });
    }
}

var popup = new mapboxgl.Popup({
    closeButton: false
});

map.on('load', function() {
  map.addSource('geojson', {
      "type": "geojson",
      "data": geojson
  });

  // Add styles to the map
  map.addLayer({
      id: 'measure-points',
      type: 'circle',
      source: 'geojson',
      paint: {
          'circle-radius': 5,
          'circle-color': '#fff'
      },
      filter: ['in', '$type', 'Point']
  });

  map.addLayer({
      id: 'measure-lines',
      type: 'line',
      source: 'geojson',
      layout: {
          'line-cap': 'round',
          'line-join': 'round'
      },
      paint: {
          'line-color': '#fff',
          'line-width': 2.5
      },
      filter: ['in', '$type', 'LineString']
  });

  dataSources.forEach(function(source) {
    deferreds.push(
      $.ajax({
        beforeSend: function(xhr) {
          if (xhr.overrideMimeType) {
            xhr.overrideMimeType("application/json");
          }
        },
        dataType: "json",
        url: source.data,
        layer_name: source.name
      })
    );
  });

  $.when.apply($, deferreds).done(function() {
     for (var i = 0; i < arguments.length; i++) {
       if(this[i].layer_name === "opened_oil_areas") {
         map.addSource(this[i].layer_name, {
           type: 'geojson',
           data: arguments[i][0]
         });

         map.addLayer({
           "id": this[i].layer_name,
           "source": this[i].layer_name,
           "type": "fill",
           "paint": {
             "fill-opacity": mapLayersStyle[this[i].layer_name].opacity,
             "fill-color": mapLayersStyle[this[i].layer_name].color,
             "fill-outline-color": mapLayersStyle[this[i].layer_name].border_color
           }
         }); // Add it before the oil prospects
       } else if(this[i].layer_name==="oilwells") {

          // Create a month property value based on time
          // used to filter against.
          arguments[i][0].features = arguments[i][0].features.map(function(d) {
              //https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/getDay
              d.properties.date = new Date(d.properties.time).getDate();
              d.properties.day = new Date(d.properties.time).getDay();
              d.properties.month = new Date(d.properties.time).getMonth();
              d.properties.year = new Date(d.properties.time).getFullYear();
              return d;
          });

          map.addSource(this[i].layer_name, {
            type: 'geojson',
            data: arguments[i][0]
          });

          map.addLayer({
              'id': this[i].layer_name,
              'type': 'circle',
              'source': this[i].layer_name,
              "layout": {
              },
              "paint": {
                  "circle-color": 'white',
                  'circle-radius': {
                      "base": 1.1,
                      "stops": [
                        [0, 1],
                        [5, 2],
                        [10, 3],
                        [20, 10]
                      ]
                  }
              },
          });

          dataLayerBounds[this[i].layer_name] = bbox_oilwells;

          // Set filter to first year
          filterBy("oilwells", years, 0);

          // Update filter on slider change
          document.getElementById('slider_oilwells').addEventListener('input', function(e) {
              var year = parseInt(e.target.value, 10);
              filterBy("oilwells", years, year);
          });
        } else if(this[i].layer_name==="export") {
          map.addSource(this[i].layer_name, {
            type: 'geojson',
            data: arguments[i][0]
          });
          dataLayerBounds[this[i].layer_name] = bbox_export;
        } else {
          map.addSource(this[i].layer_name, {
            type: 'geojson',
            data: arguments[i][0]
          });
          dataLayerBounds[this[i].layer_name] = bbox_area;
        }
     }
  });

  map.resize();
  $(".interactive-content").fadeOut(1500).promise().done(function() {
    // Fadeout done, start the timer for going through the map (set in top of script)
    $("span.loading-text").hide();
    $("#start-interactive-tour").show();
  });

  map.on("mousedown", function(e) {
    var center = map.getCenter().wrap();
    var zoom = map.getZoom();

    console.log(center, zoom, e.lngLat, e.point);
  });


  map.on('click', function(e) {
    // If measurement is turned on:
    if(measurement) {
      var features = map.queryRenderedFeatures(e.point, { layers: ['measure-points'] });

      // Remove the linestring from the group
      // So we can redraw it based on the points collection
      if (geojson.features.length > 1) geojson.features.pop();

      // Clear the Distance container to populate it with a new value
      distanceContainer.innerHTML = '';

      // If a feature was clicked, remove it from the map
      if (features.length) {
          var id = features[0].properties.id;
          geojson.features = geojson.features.filter(function(point) {
              return point.properties.id !== id;
          });
      } else {
          var point = {
              "type": "Feature",
              "geometry": {
                  "type": "Point",
                  "coordinates": [
                      e.lngLat.lng,
                      e.lngLat.lat
                  ]
              },
              "properties": {
                  "id": String(new Date().getTime())
              }
          };

          geojson.features.push(point);
      }

      if (geojson.features.length > 1) {
          linestring.geometry.coordinates = geojson.features.map(function(point) {
              return point.geometry.coordinates;
          });

          geojson.features.push(linestring);

          // Populate the distanceContainer with total distance
          var value = document.createElement('pre');
          value.textContent = 'Distance: ' + parseFloat(turf.lineDistance(linestring)).toFixed(1) + ' km'; // .toLocaleString()
          distanceContainer.appendChild(value);
      }

      map.getSource('geojson').setData(geojson);
    }
  });

  // Need this?
  map.on('zoomend', function(e) {
    var zoom = map.getZoom();
    if (zoom <= 7) {
      $(".marker-360, .marker-birds").hide();
    } else {
      $(".marker-360, .marker-birds").show();
    }

    if (zoom < 5) {
      $(".marker-corals").hide();
    } else {
      $(".marker-corals").show();
    }
  });

  // Functions for flying to a specific part of the map
  map.on('flystart', function() {
    flying = true;
  });
  map.on('flyend', function() {
    flying = false;
  });
  map.on('moveend', function(e) {
    if (!flying && zoomedToArea) {
      //map.fire(flyend);
      if (zoomed["heike"] || zoomed["gaute"] || zoomed["odda"]) {
        // We have zoomed in on the first interview, so update their marker overlay position accordingly
        //add360Icons(); // Should we move this - or even break it down for each person?
        if(!added360Markers) {
            addMarkers("360", images360);
        }

        // // Enable map filters and map controls
        // mapFiltersLocked = false;
        // mapControls(false);
      }
      zoomedToArea = false; // Always do this
    }

    // Used to be peopleAdded
    if (zoomed["heike"] || zoomed["gaute"] || zoomed["odda"]) {
      updateMarkerOverlayPos(false);
    } else if(addedBeachMarkers) {
      updateMarkerOverlayPos(true);
    }
  });
});

map.on('mousemove', function (e) {
  if(measurement) {
    var features = map.queryRenderedFeatures(e.point, { layers: ['measure-points'] });
    // UI indicator for clicking/hovering a point on the map
    map.getCanvas().style.cursor = (features.length) ? 'pointer' : 'crosshair';
  } else {
    map.getCanvas().style.cursor = 'auto'; // grab doesn't work for some reason
  }
});

// TODO: Function which only checks a subset of mapIcons? Need to be able to update overlay for specific group of markers (beach)
// TODO: Add code for rest of the 360 images of beaches . 8 in total
function updateMarkerOverlayPos(subset) {
  $(".cd-modal-action").show();
  var mi = mapIcons;
  if(subset) mi = mapIcons.slice(1).slice(-beach.features.length);
  mi.forEach(function(icon) {
    try {
      // Update the overlay if the map moves
      var point = map.project(addedMapIcons[icon].coordinates);
      $(".cd-modal-action." + icon + " ").css({
        'left': point.x - 19,
        'top': point.y - 19
      });
    } catch (err) {
      console.log(err);
    }
  });
}

// Turn on off fish stock layers
$('input[name="fish_stocks"], input[name="oil_prospects"]').on('click', function () {
    if ($(this).is(':checked')) {
        showMapLayer($(this).attr('data-layer-name'));
    } else {
        removeMapLayer($(this).attr('data-layer-name'));
    }
});

$("#hover-navigation .arrow").on("click", function() {
  if (app.navigation.state == app.navigation.visible) {
    $(".interactive-pane").css({
      "bottom": "130px"
    });
  } else if (app.navigation.state == app.navigation.hidden) {
    $(".interactive-pane").css({
      "bottom": "30px"
    });
  }
});

$("#start-interactive-tour").on("click", function(e) {
  e.preventDefault();
  map.fitBounds(bbox_oilwells);
  //map.setStyle('mapbox://styles/lovese/ciya7qynz006v2rl940yajywr');

  // TODO: Should move this into it's own function
  $(".loading").fadeOut(500);

  $(".container-full").fadeIn("1500");
  $(".interactive-pane-text").css({
    'z-index': 1
  }).show();
  $(".cd-section").css({
    'z-index': 1
  }).show();

  // Show map filters
  $("#map-filters").show();

  // If not running the tour on start:
  //showMapLayer("lovese_land");
  $("#map-filters ul li.oilwells").addClass("active");
});

// Map filter
$("#map-filters ul li").on('click', function() {
  if (!mapFiltersLocked) {
    if($(this).attr('data-layer-name') === "measure") {
      if($(this).hasClass("active")) {
        $(this).removeClass("active");
        measurement = false;
      } else {
        $(this).addClass("active");
        measurement = true;
      }
    } else if($(this).attr('data-layer-name') === "oil_prospects") {
      if($(this).hasClass("active")) {
        $(this).removeClass("active");
        show_oil = false;
        removeMapLayer("oil_prospects");
      } else {
        $(this).addClass("active");
        show_oil = true;
        showMapLayer("oil_prospects");
      }
    } else {
      $(this).siblings().each(function() {
        if(!$(this).hasClass("measure") || !$(this).hasClass("oil")) {
          $(this).removeClass("active");
          // remove any previously set info panes
          $("section[data-layer-name='" + $(this).attr('data-layer-name') + "']").removeClass("active"); // The info pane
        }
      });

      // Remove any visible layers
      for (var prop in mapLayers) {
        if (Object.prototype.hasOwnProperty.call(mapLayers,prop)){
          if(prop !== $(this).attr('data-layer-name') && mapLayers[prop].visible){
              removeMapLayer(prop);
              mapLayers[prop].visible = false;
              // Uncheck all checkboxes, except the cod checkbox
              $("input[type='checkbox']").prop( "checked", false );
              $("input[type='checkbox']#cod").prop( "checked", true );
          }
        }
      }

      $(this).addClass("active");
      // Set the current info pane number based on index of the section
      $(".map-features-count p span.current").text($(this).index() + 1);

      // Turn on this map layer
      showMapLayer($(this).attr('data-layer-name'));
      // Update the info pane which corresponds to the button
      $("section[data-layer-name='" + $(this).attr('data-layer-name') + "']").addClass("active");
    }
  }
});

// Interviewees pane - move to the area of the person on click
$(".interview").on('click', function() {
  $(this).siblings().each(function() {
    $(this).removeClass("active");
  });
  $(this).addClass("active");
  var person = $(this).attr('data-person');
  zoomToPerson(person);
});

// Hover function for 360 images - not working??
$('[data-type="modal-trigger"]').hover(function() {
  var currMarker = "image360_" + $(this).parent().attr('data-id');
  $('.marker-360[data-name="' + currMarker + '"]').css("background-image", "url(../resources/_Graphics/_GFX_006_EP3_BG/_ICN_BTN_360_Inverted@3x.png)");
  // .addClass('animated bounceIn') // Animation of the marker resets it's position (does the element need to be inline or just add display:block?)
}, function(e) {
  // on mouseout, reset the background
  var currMarker = "image360_" + $(this).parent().attr('data-id');
  $('.marker-360[data-name="' + currMarker + '"]').css("background-image", "url(../resources/_Graphics/_GFX_006_EP3_BG/_ICN_BTN_360@3x.png)");
});

// Add a given map layer to the map, except the islands layer - which has no layer
function showMapLayer(layer) {
  if (layer !== undefined || layer !== null || typeof layer !== "undefined" && layer !== "lovese_land" && layer !== "oilwells" && layer !== "people" && layer !== "emission" && layer !== "spill" && layer !== "beach") {
    if (mapLayers[layer].visible == false) {
      if (!mapLayers[layer].added && layer !== "lovese_land" && layer !== "oilwells" && layer !== "people" && layer !== "emission" && layer !== "spill" && layer !== "beach") {
        if (layer === "export") {
          map.addLayer({
            'source': 'export',
            'id': 'export',
            'type': 'fill-extrusion',
            'paint': {
              'fill-extrusion-opacity': 1,
              'fill-extrusion-color': {
                'property': 'id',
                'type': 'categorical',
                'stops': getColorStops()
              },
              'fill-extrusion-height': {
                'property': 'id',
                'type': 'categorical',
                'stops': getHeightStops()
              },
              'fill-extrusion-base': 0
            }
          });

          map.on('mousemove', 'export', function(e) {
              // Change the cursor style as a UI indicator.
              map.getCanvas().style.cursor = 'pointer';

              // Single out the first found feature.
              var feature = e.features[0];

              var info = "";
              if (typeof data_export[feature.properties.id] !== "undefined" && data_export[feature.properties.id] !== undefined && data_export[feature.properties.id] !== null && data_export[feature.properties.id] > 0) {
                info = ": " + data_export[feature.properties.id].toFixed(1) + " Million tonnes CO2 exported.";
              }

              // Display a popup with the name of the county
              popup.setLngLat(e.lngLat)
                  .setText(feature.properties.FIELDNAME + info)
                  .addTo(map);
          });

          map.on('mouseleave', 'export', function() {
              map.getCanvas().style.cursor = '';
              popup.remove();
          });

        } else {
          map.addLayer({
            "id": layer,
            "source": layer,
            "type": "fill",
            "paint": {
              "fill-opacity": mapLayersStyle[layer].opacity,
              "fill-color": mapLayersStyle[layer].color,
              "fill-outline-color": mapLayersStyle[layer].border_color
            }
          }, 'lofoten'); // Add it before the oil prospects
        }
        mapLayers[layer].added = true;
      }

      if (layer !== "lovese_land" && layer !== "oilwells" && layer !== "people" && layer !== "oil_prospects" && layer !== "emission" && layer !== "export" && layer !== "spill" && layer !== "beach") {
        map.setLayoutProperty(layer, 'visibility', 'visible');
        mapLayers[layer].visible = true;

        if(layer === "opened_oil_areas") map.setPaintProperty(layer, 'paint-opacity', 1);
        // Fit the map to the bounderies of the specific layer
        map.fitBounds(dataLayerBounds[layer], {padding: 30, linear: false, duration: 2000, offset: [200,0]});
      }

      if(layer === "opened_oil_areas") map.setPaintProperty("opened_oil_areas", 'fill-opacity', 1);

      if(layer === "oil_prospects") {
        map.setLayoutProperty(layer, 'visibility', 'visible');
        mapLayers[layer].visible = true;

        // Might use this later:
        // if(mapLayers["birds"].visible) {
        //   map.fitBounds(bbox_roest_and_oil, {padding: 30, linear: false, duration: 2000, offset: [200,0]});
        // } else if(mapLayers["corals"].visible) {
        //   map.fitBounds(bbox_corals, {padding: 30, linear: false, duration: 2000, offset: [200,0]});
        // }
        map.setPitch(0);
        map.setBearing(0);
        map.fitBounds(dataLayerBounds[layer], {padding: 30, linear: false, duration: 2000, offset: [200,0]});

      } else if(layer === "export") {
        //map.fitBounds(bbox_export);
        map.setPaintProperty("opened_oil_areas", 'fill-opacity', 0);
        map.setPaintProperty("oilwells", 'circle-opacity', 0);

        map.setLayoutProperty(layer, 'visibility', 'visible');
        mapLayers[layer].visible = true;
        filterBy("export", years, 0);

        map.easeTo({
          center: [3.1901099921844605, 59.1799289545379],
          duration: 2000,
          pitch: 60,
          bearing: 10,
          zoom: 6,
          easing: function easing(t) {
            return t * (2 - t);
          }
        });
      }
    }
  }

  // if(layer === "lovese_land") {
  //   map.fitBounds(bbox_area, {padding: 30, linear: false, duration: 2000, offset: [200,0]});
  // }
  if (layer === "oilwells") {
    map.setPitch(0);
    map.setBearing(0);
    map.setPaintProperty("opened_oil_areas", 'fill-opacity', 1);
    map.setPaintProperty(layer, 'circle-opacity', 1);
    map.fitBounds(bbox_oilwells, {padding: 20, linear: false, duration: 2000});
  }
  if (layer === "emission") {
    map.setPitch(0);
    map.setBearing(0);
    map.fitBounds(bbox_oilwells, {padding: 20, linear: false, duration: 2000});
  }
  if (layer === "spill") {
    map.setPitch(0);
    map.setBearing(0);
    map.setPaintProperty("opened_oil_areas", 'fill-opacity', 0);
    if(!addedSpillMarkers) {
        addMarkers("spill", oil_spills);
    }
    map.fitBounds(bbox_spill, {padding: 20, linear: false, duration: 2000});
  }
  if (layer === "beach") {
    map.setPitch(0);
    map.setBearing(0);
    map.setPaintProperty("opened_oil_areas", 'fill-opacity', 0);
    if(!addedBeachMarkers) {
        addMarkers("beach", beach);
    }
    map.fitBounds(bbox_area, {padding: 50, linear: false, duration: 2000, offset: [100,0]});
  }
  if (layer === "people") {
    map.setPitch(0);
    map.setBearing(0);
    map.setPaintProperty("opened_oil_areas", 'fill-opacity', 0);
    addMarkers("people", people);
    map.fitBounds(bbox_people, {padding: 50, linear: false, duration: 2000, offset: [100,0]});
  }
}

// Remove a given map layer, except the islands layer - which has no layer
function removeMapLayer(layer) {
  if (layer !== undefined || layer !== null || typeof layer !== "undefined" && layer !== "lovese_land" && layer !== "oilwells" && layer !== "people" && layer !== "beach") {
    if (mapLayers[layer].visible == true && layer !== "lovese_land" && layer !== "oilwells" && layer !== "people" && layer !== "beach") {
      map.setLayoutProperty(layer, 'visibility', 'none');
      // if (layer === "lovese_sea") {
      //   map.setLayoutProperty("lovese-labels", 'visibility', 'none');
      // }
      mapLayers[layer].visible = false;
    }
  }
  if(layer === "oilwells") {
    mapLayers[layer].visible = false;
  }
}

// Add markers to the map
function addMarkers(name, markers) {
  markers.features.forEach(function(marker) {
    // create a DOM element for the marker
    var el = document.createElement('div');
    el.className = 'marker-' + name;

    el.style.backgroundImage = 'url(../resources/_Graphics/' + marker.properties.imgPath + marker.properties.imgName + '.png)';
    el.style.width = marker.properties.iconSize[0] + 'px';
    el.style.height = marker.properties.iconSize[1] + 'px';

    //var point = map.project(marker.geometry.coordinates);
    addedMapIcons[marker.properties.name].coordinates = marker.geometry.coordinates;

    if(name === "people") {
      addedPeople = true;
      el.addEventListener('click', function() {
        zoomToPerson(marker.properties.name);
      });
    } else if (name === "beach" || name == "spill") {
      el.addEventListener('click', function() {
        // Add reference to function which will handle stuff from here.
        // Add popup handler here.
      });
      el.addEventListener('mouseover', function (e) {
        $(this).css("background-image", "url(../resources/_Graphics/_GFX_006_EP3_BG/_ICN_BTN_"+name+"_Inverted@3x.png)");
      });
      el.addEventListener('mouseout', function (e) {
        $(this).css("background-image", "url(../resources/_Graphics/_GFX_006_EP3_BG/_ICN_BTN_"+name+"@3x.png)");
      });
      if(name === "beach") {
        addedBeachMarkers = true;
      } else if(name === "spill") {
        addedSpillMarkers = true;
      }
    } else if (name === '360') {
      added360Markers = true;
      el.addEventListener('mouseover', function (e) {
        $(this).css("background-image", "url(../resources/_Graphics/_GFX_006_EP3_BG/_ICN_BTN_"+name+"_Inverted@3x.png)");
      });
      el.addEventListener('mouseout', function (e) {
        $(this).css("background-image", "url(../resources/_Graphics/_GFX_006_EP3_BG/_ICN_BTN_"+name+"@3x.png)");
      });
    }

    if(name === "spill") {
      new mapboxgl.Marker(el)
        .setLngLat(marker.geometry.coordinates)
        .setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
        .setHTML('<h3>' + marker.properties.title + ' ('+marker.properties.year+')' +'</h3><p>' + marker.properties.description + 'Recorded spillage of '+ marker.properties.tonnes.toLocaleString() +' tonnes of oil, or '+ marker.properties.liter.toLocaleString() + ' literes.</p>'))
        .addTo(map);
    } else {
      console.log("Add marker to map", el, marker.geometry.coordinates);
      new mapboxgl.Marker(el)
        .setLngLat(marker.geometry.coordinates)
        .addTo(map);
    }
  });
}

// Zoom the map to a given person
function zoomToPerson(name) {
  // zoomElement, center, zoom, speed, curve, pitch, bearing, offset
  zoomToArea(name, addedMapIcons[name].coordinates, 11.5, 1, 1, 150, -10, [350, 0]);
  addedMapIcons[name].zoomedTo = true;
  addedMapIcons[name].clicked += 1;
}

// Zoom to a given area
function zoomToArea(zoomElement, center, zoom, speed, curve, pitch, bearing, offset) {
  if (app.navigation.state == app.navigation.visible) {
    $(".interactive-pane").css({
      "bottom": "30px"
    });
    app.navigation.toggle(); // toggle the nav
  }
  zoomed[zoomElement] = true;
  zoomedToArea = true;
  map.flyTo({
    center: center, //[12.901721434467618,68.71391887946749],
    zoom: zoom,
    offset: offset,
    // For perspective on the zoom - implement this to handle specific sections (oil prospects etc.)
    pitch: pitch, // pitch in degrees - 80
    bearing: bearing, // bearing in degrees - 15

    // These options control the flight curve, making it move
    // slowly and zoom out almost completely before starting
    // to pan.
    speed: speed, //0.5, // make the flying slow
    curve: curve, //1.5, // change the speed at which it zooms out

    // This can be any easing function: it takes a number between
    // 0 and 1 and returns another number between 0 and 1.
    easing: function(t) {
      return t;
    }
  });
}


// Open videos and 360s:
$('[data-type="modal-trigger"]').on('click', function(e) {
  e.preventDefault();
  var contentUrl = "";

    if ($(this).parent().attr('data-type') == 'person') {
      switch ($(this).parent().attr('data-id')) {
        case "heike":
          contentUrl = "//player.vimeo.com/video/232229142?byline=0&amp;portrait=0";
          break;
        case "gaute":
          contentUrl = "//player.vimeo.com/video/232225808?byline=0&amp;portrait=0";
          break;
        case "odda":
          contentUrl = "//player.vimeo.com/video/232225882?byline=0&amp;portrait=0";
          break;
      }
    } else
  if ($(this).parent().attr('data-type') == 'images360') {
    switch ($(this).parent().attr('data-id')) {
      case "1":
        contentUrl = "../resources/_360/Henningsver.html?vr&s=pano1473";
        break;
      case "2":
        contentUrl = "../resources/_360/Henningsver.html?vr&s=pano1472";
        break;
      case "3":
        contentUrl = "../resources/_360/KabelvaagSvolver.html";
        break;
      case "4":
        contentUrl = "../resources/_360/KabelvaagSvolver.html?vr&s=pano1473";
        break;
      case "5":
        contentUrl = "../resources/_360/KabelvaagSvolver.html?vr&s=pano1475";
        break;
      case "6":
        contentUrl = "../resources/_360/KabelvaagSvolver.html?vr&s=pano1476";
        break;
      case "7":
        contentUrl = "../resources/_360/Beaches.html?vr&s=pano1710";
        break;
      case "8":
        contentUrl = "../resources/_360/Beaches.html?vr&s=pano1703";
        break;
      case "9":
        contentUrl = "../resources/_360/Beaches.html?vr&s=pano1704";
        break;
      case "10":
        contentUrl = "../resources/_360/Beaches.html?vr&s=pano1705";
        break;
      case "11":
        contentUrl = "../resources/_360/Beaches.html?vr&s=pano1706";
        break;
      case "12":
        contentUrl = "../resources/_360/Beaches.html?vr&s=pano1707";
        break;
      case "13":
        contentUrl = "../resources/_360/Beaches.html?vr&s=pano1708";
        break;
      case "14":
        contentUrl = "../resources/_360/Beaches.html?vr&s=pano1709";
        break;
    }
  }
  $("#overlayContent").attr("src", contentUrl);

  var actionBtn = $(this),
    scaleValue = retrieveScale(actionBtn.next('.cd-modal-bg'));

  actionBtn.addClass('to-circle');
  actionBtn.next('.cd-modal-bg').addClass('is-visible').one('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function() {
    animateLayer(actionBtn.next('.cd-modal-bg'), scaleValue, true);
  });

  //if browser doesn't support transitions...
  if (actionBtn.parents('.no-csstransitions').length > 0) animateLayer(actionBtn.next('.cd-modal-bg'), scaleValue, true);

});

//trigger the animation - close modal window
$('.cd-section .cd-modal-close').on('click', function() {
  closeModal();
});

$(document).keyup(function(event) {
  if (event.which == '27') closeModal();
});

$(window).on('resize', function() {
  //on window resize - update cover layer dimention and position
  if ($('.cd-section.modal-is-visible').length > 0) window.requestAnimationFrame(updateLayer);
});

function retrieveScale(btn) {
  var btnRadius = btn.width() / 2,
    left = btn.offset().left + btnRadius,
    top = btn.offset().top + btnRadius - $(window).scrollTop(),
    scale = scaleValue(top, left, btnRadius, $(window).height(), $(window).width());

  btn.css('position', 'fixed').velocity({
    top: top - btnRadius,
    left: left - btnRadius,
    translateX: 0,
  }, 0);

  return scale;
}

function scaleValue(topValue, leftValue, radiusValue, windowW, windowH) {
  var maxDistHor = (leftValue > windowW / 2) ? leftValue : (windowW - leftValue),
    maxDistVert = (topValue > windowH / 2) ? topValue : (windowH - topValue);
  return Math.ceil(Math.sqrt(Math.pow(maxDistHor, 2) + Math.pow(maxDistVert, 2)) / radiusValue);
}

function animateLayer(layer, scaleVal, bool) {
  layer.velocity({
    scale: scaleVal
  }, 400, function() {
    $('body').toggleClass('overflow-hidden', bool);
    (bool) ?
    layer.parents('.cd-section').addClass('modal-is-visible').end().off('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend'): layer.removeClass('is-visible').removeAttr('style').siblings('[data-type="modal-trigger"]').removeClass('to-circle');
  });
}

function updateLayer() {
  var layer = $('.cd-section.modal-is-visible').find('.cd-modal-bg'),
    layerRadius = layer.width() / 2,
    layerTop = layer.siblings('.btn').offset().top + layerRadius - $(window).scrollTop(),
    layerLeft = layer.siblings('.btn').offset().left + layerRadius,
    scale = scaleValue(layerTop, layerLeft, layerRadius, $(window).height(), $(window).width());

  layer.velocity({
    top: layerTop - layerRadius,
    left: layerLeft - layerRadius,
    scale: scale,
  }, 0);
}

function closeModal() {
  $("#overlayContent").attr("src", "");
  var section = $('.cd-section.modal-is-visible');
  section.removeClass('modal-is-visible').one('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function() {
    animateLayer(section.find('.cd-modal-bg'), 1, false);
  });
  //if browser doesn't support transitions...
  if (section.parents('.no-csstransitions').length > 0) animateLayer(section.find('.cd-modal-bg'), 1, false);
}

/*
*   Oil emissions layer
*/

var chartData = {
    labels: [],
    datasets: [{
        type: 'line',
        label: "Share of Norway's CO2-emissions",
        borderColor: "#354651",
        borderWidth: 2,
        fill: false,
        yAxisID: 'B',
        data: []
    }, {
        type: 'bar',
        label: 'CO2-emissions',
        backgroundColor: "#E7A930",
        data: [],
        borderColor: 'white',
        borderWidth: 0,
        yAxisID: 'A'
    }]

};

window.onload = function() {
    var ctx = document.getElementById("canvas_emissions").getContext("2d");
    window.myMixedChart = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        scaleFontColor: '#fff',
        options: {
            legend: { display: false },
            scaleFontColor: '#fff',
            responsive: true,
            gridLines: {
                display: false,
                drawBorder: false
            },
            title: {
                display: false,
                text: ''
            },
            tooltips: {
                mode: 'index',
                intersect: true
            },
            scales: {
              xAxes: [{
                ticks: {
                  fontSize: 10,
                  fontColor:"#fff"
                },
                scaleLabel: {
                   display: true,
                   fontSize: 10,
                   fontColor:"#fff"
                },
                gridLines: {
                  display: false,
                  color: "#fff"
                },
              }],
              yAxes: [{
                gridLines: {
                  display: false,
                  color: "#fff"
                },
                id: 'A',
                type: 'linear',
                position: 'left',
                ticks: {
                  fontColor:"#fff",
                  min: 0,
                  max: 50,
                  fontSize: 10
                },
                scaleLabel: {
                   display: false,
                   labelString: "Million tonnes CO2",
                   fontSize: 10,
                   fontColor:"#fff"
                }
              }, {
                id: 'B',
                type: 'linear',
                position: 'right',
                ticks: {
                   fontColor:"#fff",
                   min: 10,
                   max: 35,
                   fontSize: 10,
                   callback: function(value){return value+ "%"}
                  },
                  scaleLabel: {
                     display: false,
                     labelString: "Percentage",
                     fontSize: 10,
                     fontColor:"#fff"
                  }
                }
              ]
            }
        }
    });
};

function addData(year) {
  if (chartData.datasets.length > 0) {
      chartData.labels.push(years[year])
      chartData.datasets[0].data.push((oil_prod_emissions_share[year]*100).toFixed(1));
      chartData.datasets[1].data.push(oil_prod_emissions[year].toFixed(1));

      window.myMixedChart.update();
  }
}
function removeData() {
  chartData.labels.splice(-1, 1); // remove the label first
  chartData.datasets.forEach(function(dataset, datasetIndex) {
      dataset.data.pop();
  });
  window.myMixedChart.update();
}

document.getElementById('slider_emissions').addEventListener('input', function(e) {
  var year = parseInt(e.target.value, 10);
  if (year < prev) {
    removeData()
  } else {
    addData(year)
  }
  prev = year;
});

document.getElementById('slider_export').addEventListener('input', function(e) {
    var year = parseInt(e.target.value, 10);
    filterBy("export", years, year);
});

/*
*   Oil export layer
*/
// Get the percentage for a value
var min = 0;
var max = 120;
function getPercentage(value) {
  if (!Number(value)) {
    return 0;
  }

  var totalDiff = max - min,
      valueDiff = value - min;
  var percentage = valueDiff / totalDiff * 300;

  percentage = Math.max(percentage, 0);
  percentage = Math.min(percentage, 100);

  return percentage;
}

// Get the color for a value depending on the percentage
var begin = { red: 255, green: 242, blue: 0 };
var end = { red: 237, green: 66, blue: 100 };
function getColor(value) {
  var percentage = getPercentage(value) / 100;

  var red = begin.red + Math.floor(percentage * (end.red - begin.red));
  var green = begin.green + Math.floor(percentage * (end.green - begin.green));
  var blue = begin.blue + Math.floor(percentage * (end.blue - begin.blue));

  return 'rgb(' + red + ',' + green + ',' + blue + ')';
}

// Get the categorical color stops for the areas
function getColorStops() {
  var stops = [['no match', '#f2f2f2']];

  Object.keys(data_export).forEach(function (id) {
    var value = data_export[id];

    if (!value || isNaN(value)) {
      return;
    }

    var color = getColor(value, min, max);

    stops.push([id, color]);
  });

  return stops;
}

// Get the height stops for the areas
function getHeightStops() {
  var stops = [['no match', 0]];

  Object.keys(data_export).forEach(function (id) {
    var value = data_export[id];

    if (!value || isNaN(value)) {
      return;
    }

    var percentage = Math.floor(getPercentage(value));
    var height = percentage * 600;
    stops.push([id, height]);
  });

  return stops;
}
